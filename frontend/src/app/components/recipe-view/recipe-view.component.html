<div class="flex min-h-screen w-full flex-col items-start justify-center">
  @if (showDeleteModal) {
  <div class="fixed inset-0 z-50 flex items-center justify-center visibleBackdrop"
    style="backdrop-filter: blur(10px); background: var(--primary-backdrop); pointer-events: auto;"
    (click)="onDeleteBackdropClick($event)">
    <div class="w-11/12 max-w-4xl rounded-3xl shadow-2xl p-8 relative transition-all"
      style="background: var(--primary-200);">
      <button
        class="absolute top-6 right-6 w-12 h-12 rounded-full flex items-center justify-center transition-all hover:scale-110 hover:rotate-90"
        style="background: var(--primary-400); color: white; box-shadow: 0 4px 12px var(--primary-300);"
        (click)="closeDeleteModal($event)">
        <i class="ti ti-x text-2xl"></i>
      </button>
      <div class="flex flex-col items-center gap-6 mb-8">
        <div class="flex items-center gap-3">
          <i class="ti ti-trash text-4xl" style="color: var(--error);"></i>
          <span class="text-2xl font-semibold" style="color: var(--error);">{{ t('delete_recipe') }}</span>
        </div>
        <p class="text-lg font-medium" style="color: var(--primary-700);">{{ t('delete_recipe_confirm') }}</p>
        <div class="flex gap-4 mt-4">
          <button
            class="px-8 py-4 rounded-2xl text-lg font-semibold flex items-center gap-3 transition-all hover:scale-105 shadow-lg"
            style="background: var(--primary-400); color: white;" (click)="closeDeleteModal($event)">{{ t('cancel')
            }}</button>
          <button
            class="px-8 py-4 rounded-2xl text-lg font-semibold flex items-center gap-3 transition-all hover:scale-105 shadow-lg"
            style="background: red; color: white;" (click)="confirmDeleteRecipe($event)"><i
              class="ti ti-trash text-2xl"></i> {{ t('delete') }}</button>
        </div>
      </div>
    </div>
  </div>
  }
  <!-- Main Content -->
  <div
    class="container min-h-fit max-w-none flex w-full grow shrink-0 basis-0 flex-col items-center gap-4 py-12 mt-32 overflow-auto">
    <div class="flex w-full max-w-screen-2xl min-h-full flex-col items-start gap-8">

      <ng-template #recipeContent>
        <!-- Recipe Header -->
        <div class="recipeCont flex w-full flex-col gap-8 rounded-3xl border border-solid px-8 py-8 shadow-sm glass"
          style="border-color: var(--primary-100-40); background: var(--primary-200-40);">

          <div class="flex items-center gap-8 recipe-header">
            <!-- Recipe Image -->
            <div class="relative w-2/4">
              <img *ngIf="user?.imageString || recipe?.imageUrl"
                class="w-full h-full aspect-square rounded-3xl object-cover shadow-lg"
                src="data:image/png;base64,{{ recipe?.imageString || recipe?.imageUrl}}" alt="{{ recipe?.title }}" />
              <img *ngIf="!recipe?.imageString && !recipe?.imageUrl"
                class="w-full h-full aspect-square rounded-3xl object-cover shadow-lg" src="assets/img/recipe.png"
                alt="{{ recipe?.title }}" />

              <!-- Image Actions -->
              <div class="absolute top-4 right-4 flex gap-2">
                @if (isAuthenticated) {
                <button (click)="toggleFavorite()"
                  class="glass-strong w-12 h-12 rounded-full flex items-center justify-center backdrop-blur-md transition-transform hover:scale-110"
                  [class.favorites-active]="isInFavorites">
                  <i class="ti text-xl" [class.ti-heart]="!isInFavorites" [class.ti-heart-filled]="isInFavorites"
                    [style.color]="isInFavorites ? 'var(--error)' : 'var(--primary-500)'"></i>
                </button>
                <button (click)="openAddToCollection(recipe?.id, $event)"
                  class="glass-strong w-12 h-12 rounded-full flex items-center justify-center backdrop-blur-md transition-transform hover:scale-110">
                  <i class="ti ti-bookmark text-xl" style="color: var(--primary-500);"></i>
                </button>
                }
                <button (click)="shareRecipe()"
                  class="glass-strong w-12 h-12 rounded-full flex items-center justify-center backdrop-blur-md transition-transform hover:scale-110">
                  <i class="ti ti-share text-xl" style="color: var(--primary-500);"></i>
                </button>
              </div>
            </div>

            <!-- Recipe Info -->
            <div class="w-3/4">
              @if (isAuthenticated && (user?.username === recipe?.author || user?.role === 'ADMIN')) {
              <div class="recipeOptions absolute top-8 right-8 flex gap-2">
                <button routerLink="/recipes/{{ recipe?.id }}/edit"
                  class="w-12 h-12 flex items-center justify-center rounded-xl"
                  style="background: var(--gradient-primary); color: white;">
                  <i class="ti ti-edit text-primary-700 text-xl"></i>
                </button>
                <button (click)="openDeleteModal()" class="w-12 h-12 flex items-center justify-center rounded-xl"
                  style="background: red; color: white;">
                  <i class="ti ti-trash text-xl"></i>
                </button>
              </div>
              }
              <div class="flex flex-col gap-6">
                <div class="recipeTexts flex flex-col gap-4">
                  <h1 class="text-4xl font-bold recipe-title max-w-[75%]"
                    style="color: var(--primary-700); font-kerning: none;">
                    {{ recipe?.title }}
                  </h1>
                  <p class="text-lg" style="color: var(--primary-400);">
                    {{ recipe?.description }}
                  </p>
                </div>

                <!-- Author Info -->
                <div class="chefInfo flex items-center gap-4">
                  @if (authorPfp) {
                  <img class="w-12 h-12 rounded-full object-cover cursor-pointer border-2"
                    routerLink="/users/{{recipe?.author}}" src="{{ authorPfp }}"
                    style="background: var(--primary-400); border-color: var(--primary-300)" alt="Chef" />
                  } @else {
                  <img class="w-12 h-12 rounded-full object-cover cursor-pointer border-2"
                    routerLink="/users/{{recipe?.author}}" src="assets/img/user.png"
                    style="background: var(--primary-400); border-color: var(--primary-300)" alt="Chef" />
                  }
                  @if (recipe?.author) {
                  <div>
                    <p class="font-semibold" style="color: var(--primary-700);">{{ t('chef') }} {{ recipe?.author }}</p>
                    <p class="text-sm" style="color: var(--primary-400);">{{ t('published') }}
                      {{ created }}
                      @if (recipe?.updatedAt) {
                      | {{ t('updated_on') }} {{ lastUpdated }}
                      }
                    </p>
                  </div>
                  } @else {
                  <div>
                    <p class="font-semibold" style="color: var(--primary-700);">{{ t('unknown_chef') }}</p>
                    <p class="text-sm" style="color: var(--primary-400);">{{ t('published') }}
                      {{ created }}
                      @if (recipe?.updatedAt) {
                      | {{ t('updated_on') }} {{ lastUpdated }}
                      }
                    </p>
                  </div>
                  }
                </div>

                <div class="flex justify-center">
                  <hr class="border-t w-3/4" style="border-color: var(--primary-300);" />
                </div>

                <!-- Recipe Stats -->
                <div class="recipeStats flex flex-row justify-center md:grid-cols-4 gap-4">
                  <div class="flex flex-col items-center p-4 glass h-auto w-full justify-center"
                    style="background: var(--primary-200-40);">
                    <i class="ti ti-clock text-2xl mb-2" style="color: var(--primary-500);"></i>
                    <span class="text-sm font-semibold mx-auto w-max" style="color: var(--primary-400);">{{
                      t('total_time') }}</span>
                    <span class="text-lg font-bold" style="color: var(--primary-700);">{{ recipe?.totalTime }} {{
                      t('min') }}</span>
                  </div>
                  <div class="flex flex-col items-center p-4 glass h-auto w-full justify-center"
                    style="background: var(--primary-200-40);">
                    <i class="ti ti-users text-2xl mb-2" style="color: var(--primary-500);"></i>
                    <span class="text-sm font-semibold" style="color: var(--primary-400);">{{ t('servings') }}</span>
                    <span class="text-lg font-bold" style="color: var(--primary-700);">{{ recipe?.people }}</span>
                  </div>
                  <div class="flex flex-col items-center p-4 glass h-auto w-full justify-center"
                    style="background: var(--primary-200-40);">
                    <i class="ti ti-star text-2xl mb-2" style="color: var(--primary-500);"></i>
                    <span class="text-sm font-semibold" style="color: var(--primary-400);">{{ t('rating') }}</span>
                    <span class="text-lg font-bold" style="color: var(--primary-700);">{{ recipe?.rating }}</span>
                  </div>
                  <div class="flex flex-col items-center p-4 glass h-auto w-full justify-center"
                    style="background: var(--primary-200-40);">
                    <div class="flex flex-row justify-center gap-0 mb-2">
                      @for (i of [1,2,3,4,5]; track i) {
                      <i class="flex justify-center text-xl w-4 ti"
                        [class.ti-point-filled]="i <= (recipe?.difficulty || 3)"
                        [class.ti-point]="i > (recipe?.difficulty || 3)" style="color: var(--primary-500);"></i>
                      }
                    </div>
                    <span class="text-sm font-semibold" style="color: var(--primary-400);">{{ t('difficulty') }}</span>
                    <span class="text-lg font-bold text-center" style="color: var(--primary-700);">{{
                      getDifficultyLabel() }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Content Tabs -->
          <div class="flex w-full">
            <div class="tabs glass text-nowrap w-full">
              <button class="tab" [class.active]="activeTab === 'instructions'" (click)="setActiveTab('instructions')">
                <i class="ti ti-list-details text-2xl" aria-hidden="true"></i>
                {{ t('instructions') }}
              </button>
              <button class="tab" [class.active]="activeTab === 'nutrition'" (click)="setActiveTab('nutrition')">
                <i class="ti ti-info-circle text-2xl" aria-hidden="true"></i>
                {{ t('details_tags') }}
              </button>
              <button class="tab" [class.active]="activeTab === 'reviews'" (click)="setActiveTab('reviews')">
                <i class="ti ti-stars text-2xl" aria-hidden="true"></i>
                {{ t('reviews') }} ({{ recipe?.reviews?.length || 0 }})
              </button>
            </div>
          </div>

          <!-- Recipe Content -->
          <div class="gap-8 w-full">

            <!-- Instructions Panel -->
            @if (activeTab === 'instructions') {
            <div class="lg:col-span-2 instructionsContainer">
              <div class="flex flex-col gap-8 rounded-3xl border border-solid px-8 py-8 shadow-sm glass"
                style="border-color: var(--primary-100-40); background: var(--primary-200-40);">

                <!-- Header Section -->
                <div class="flex flex-col items-center justify-center gap-2">
                  <div class="flex items-center gap-1 text-center">
                    <i class="ti ti-clock text-2xl" style="color: var(--primary-700);"></i>
                    <p class="font-semibold" style="color: var(--primary-700);">{{ t('total_time') }}: {{
                      recipe?.totalTime }} {{ t('min') }}</p>
                  </div>
                  <button (click)="startTimer()"
                    class="startBut max-w-xs w-1/5 px-4 py-3 rounded-2xl text-sm font-semibold transition-all hover:scale-105 flex items-center justify-center gap-2"
                    style="background: var(--gradient-primary); color: white;">
                    <i class="ti ti-tools-kitchen text-xl"></i>
                    {{ t('start') }}
                  </button>
                </div>

                <div class="space-y-4">
                  @for (step of recipe?.steps; track $index) {
                  <div class="flex items-center gap-6 instruction-step">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl flex-shrink-0"
                      style="background: var(--primary-500); color: white; font-weight: bold;">
                      {{ $index + 1 }}
                    </div>
                    <div class="flex-1 p-4 glass instruction-desc" style="background: var(--primary-200-40);">
                      <p class="font-medium" style="color: var(--primary-700);">{{ step }}</p>
                    </div>
                  </div>
                  }
                </div>
              </div>
            </div>
            }

            <!-- Details & Tags Panel -->
            @if (activeTab === 'nutrition') {
            <div class="lg:col-span-2 nutritionContainer" [class.slide-left]="animationMode === 'left'"
              [class.slide-right]="animationMode === 'right'">
              <div class="details flex flex-col gap-6 rounded-3xl border border-solid px-8 py-8 shadow-sm glass"
                style="border-color: var(--primary-100-40); background: var(--primary-200-40);">

                <!-- Cuisine Types -->
                @if (getCuisineTypes().length > 0) {
                <div>
                  <h4 class="text-lg font-semibold mb-3 flex items-center gap-2" style="color: var(--primary-700);">
                    <i class="ti ti-world"></i>
                    {{ t('cuisine_type') }}
                  </h4>
                  <div class="flex flex-wrap gap-2">
                    @for (cuisine of getCuisineTypes(); track cuisine) {
                    <span class="recipeTag px-4 py-2 rounded-xl glass hover:scale-105 transition-all"
                      style="background: var(--primary-500); color: white;">
                      {{ cuisine }}
                    </span>
                    }
                  </div>
                </div>
                }

                <!-- Meal Types -->
                @if (getMealTypes().length > 0) {
                <div>
                  <h4 class="text-lg font-semibold mb-3 flex items-center gap-2" style="color: var(--primary-700);">
                    <i class="ti ti-tools-kitchen-2"></i>
                    {{ t('meal_type') }}
                  </h4>
                  <div class="flex flex-wrap gap-2">
                    @for (mealType of getMealTypes(); track mealType) {
                    <span class="recipeTag px-4 py-2 rounded-xl glass hover:scale-105 transition-all"
                      style="background: var(--primary-400); color: white;">
                      {{ mealType }}
                    </span>
                    }
                  </div>
                </div>
                }

                <!-- Dish Types -->
                @if (getDishTypes().length > 0) {
                <div>
                  <h4 class="text-lg font-semibold mb-3 flex items-center gap-2" style="color: var(--primary-700);">
                    <i class="ti ti-chef-hat"></i>
                    {{ t('dish_type') }}
                  </h4>
                  <div class="flex flex-wrap gap-2">
                    @for (dishType of getDishTypes(); track dishType) {
                    <span class="recipeTag px-4 py-2 rounded-xl glass hover:scale-105 transition-all"
                      style="background: var(--primary-300-40); color: var(--primary-700);">
                      {{ dishType }}
                    </span>
                    }
                  </div>
                </div>
                }

                <!-- Diet Labels Info -->
                @if (getDietLabels().length > 0) {
                <div>
                  <h4 class="text-lg font-semibold mb-3 flex items-center gap-2" style="color: var(--primary-700);">
                    <i class="ti ti-salad"></i>
                    {{ t('diet_information') }}
                  </h4>
                  <div class="flex flex-wrap gap-2">
                    @for (label of getDietLabels(); track label) {
                    <span class="recipeTag px-4 py-2 rounded-xl glass hover:scale-105 transition-all"
                      style="background: var(--primary-300-40); color: var(--primary-700);">
                      {{ label }}
                    </span>
                    }
                  </div>
                </div>
                }

                <!-- Health Labels Info -->
                @if (getHealthLabels().length > 0) {
                <div>
                  <h4 class="text-lg font-semibold mb-3 flex items-center gap-2" style="color: var(--primary-700);">
                    <i class="ti ti-heartbeat"></i>
                    {{ t('health_information') }}
                  </h4>
                  <div class="flex flex-wrap gap-2">
                    @for (label of getHealthLabels(); track label) {
                    <span class="recipeTag px-4 py-2 rounded-xl glass hover:scale-105 transition-all">
                      {{ label }}
                    </span>
                    }
                  </div>
                </div>
                }

                <!-- Cautions -->
                @if (getCautions().length > 0) {
                <div>
                  <h4 class="text-lg font-semibold mb-3 flex items-center gap-2">
                    <i class="ti ti-alert-triangle"></i>
                    {{ t('allergen_warnings') }}
                  </h4>
                  <div class="flex flex-wrap gap-2">
                    @for (caution of getCautions(); track caution) {
                    <span class="recipeTag px-4 py-2 rounded-xl glass hover:scale-105 transition-all">
                      {{ caution }}
                    </span>
                    }
                  </div>
                </div>
                }

                <!-- Divider -->
                <div class="flex justify-center my-4">
                  <hr class="border-t w-full" style="border-color: var(--primary-300);" />
                </div>

                <!-- Nutritional Information -->
                <h3 class="text-xl font-semibold flex items-center gap-2" style="color: var(--primary-700);">
                  <i class="ti ti-report"></i>
                  {{ t('nutritional_information') }}
                </h3>

                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                  <!-- Calories -->
                  <div class="flex flex-col items-center p-4 glass hover:scale-110 transition-all"
                    style="background: var(--primary-200-40);">
                    <i class="ti ti-flame text-3xl mb-2" style="color: var(--primary-500);"></i>
                    <span class="text-sm font-semibold" style="color: var(--primary-400);">{{ t('calories_kcal')
                      }}</span>
                    <span class="text-2xl font-bold" style="color: var(--primary-700);">{{ recipe?.calories || 0
                      }}</span>
                    <span class="text-xs" style="color: var(--primary-400);">kcal</span>
                  </div>

                  <!-- Total Weight -->
                  <div class="flex flex-col items-center p-4 glass hover:scale-110 transition-all"
                    style="background: var(--primary-200-40);">
                    <i class="ti ti-scale text-3xl mb-2" style="color: var(--primary-500);"></i>
                    <span class="text-sm font-semibold" style="color: var(--primary-400);">{{ t('total_weight_g')
                      }}</span>
                    <span class="text-2xl font-bold" style="color: var(--primary-700);">{{ recipe?.totalWeight || 0
                      }}</span>
                    <span class="text-xs" style="color: var(--primary-400);">g</span>
                  </div>

                  <!-- Per Serving -->
                  <div class="flex flex-col items-center p-4 glass hover:scale-110 transition-all"
                    style="background: var(--primary-200-40);">
                    <i class="ti ti-users text-3xl mb-2" style="color: var(--primary-500);"></i>
                    <span class="text-sm font-semibold" style="color: var(--primary-400);">{{ t('per_serving') }}</span>
                    <span class="text-2xl font-bold" style="color: var(--primary-700);">{{ (recipe?.calories || 0) /
                      (recipe?.people || 1) | number:'1.0-0' }}</span>
                    <span class="text-xs" style="color: var(--primary-400);">kcal</span>
                  </div>
                </div>
              </div>
            </div>
            }

            <!-- Reviews Panel -->
            @if (activeTab === 'reviews') {
            <div class="lg:col-span-2 reviewsContainer">
              <div class="flex flex-col gap-6 rounded-3xl border border-solid px-8 py-8 shadow-sm glass"
                style="border-color: var(--primary-100-40); background: var(--primary-200-40);">

                @if (isRecipeAuthor && !isAdmin) {
                <div class="p-6 rounded-2xl text-center glass">
                  <i class="ti ti-chef-hat text-4xl mb-2"></i>
                  <p class="font-semibold text-lg mb-1">
                    {{ t('this_is_your_recipe') }}
                  </p>
                  <p class="text-sm">
                    {{ t('cannot_review_own') }}
                  </p>
                </div>
                } @else if (isAuthenticated) {
                @if (!showReviewForm && !userHasReview) {
                <button (click)="toggleReviewForm()"
                  class="addReviewBut w-full px-6 py-4 rounded-2xl text-base font-semibold transition-all hover:scale-[1.02] flex items-center justify-center gap-3"
                  style="background: var(--gradient-primary); color: white;">
                  <i class="ti ti-pencil-star text-2xl"></i>
                  {{ t('write_a_review') }}
                </button>
                } @else if (showReviewForm) {
                <div class="p-6 glass rounded-2xl reviewForm" style="background: var(--primary-300-40);">
                  <div class="flex items-center justify-between mb-4">
                    <h4 class="text-lg font-semibold" style="color: var(--primary-700);">
                      <i class="ti ti-pencil mr-2"></i>
                      {{ t('write_your_review') }}
                    </h4>
                    <button (click)="toggleReviewForm()"
                      class="w-8 h-8 rounded-full flex items-center justify-center transition-all hover:scale-110"
                      style="background: var(--primary-400); color: white;">
                      <i class="ti ti-x"></i>
                    </button>
                  </div>

                  <div class="mb-4">
                    <label class="block text-sm font-semibold mb-2" style="color: var(--primary-700);">
                      {{ t('your_rating') }} *
                    </label>
                    <div class="flex gap-2">
                      @for (i of [1,2,3,4,5]; track i) {
                      <button type="button" (click)="setRating(i)" (mouseenter)="setHoverRating(i)"
                        (mouseleave)="clearHoverRating()" class="transition-all hover:scale-125">
                        <i class="ti ti-star-filled text-3xl"
                          [style.color]="i <= (reviewHoverRating || newReview.rating) ? '#eab308' : 'var(--primary-300)'"></i>
                      </button>
                      }
                    </div>
                  </div>

                  <!-- Rich text editotr -->
                  <div class="mb-2">
                    <label class="block text-sm font-semibold mb-2" style="color: var(--primary-700);">
                      {{ t('your_comment') }} *
                    </label>
                    <div class="decorations flex gap-2 p-2 rounded-lg mb-2 w-max"
                      style="background: var(--primary-200-40);">
                      <button type="button" (click)="applyFormat($event, 'bold')"
                        class="w-8 h-8 rounded flex items-center justify-center transition-all hover:scale-110 toolbar-button"
                        style="background: var(--primary-300-40);" title="{{ t('bold') }}">
                        <i class="ti ti-bold" style="color: var(--primary-700);"></i>
                      </button>
                      <button type="button" (click)="applyFormat($event, 'italic')"
                        class="w-8 h-8 rounded flex items-center justify-center transition-all hover:scale-110 toolbar-button"
                        style="background: var(--primary-300-40);" title="{{ t('italic') }}">
                        <i class="ti ti-italic" style="color: var(--primary-700);"></i>
                      </button>
                      <button type="button" (click)="applyFormat($event, 'underline')"
                        class="w-8 h-8 rounded flex items-center justify-center transition-all hover:scale-110 toolbar-button"
                        style="background: var(--primary-300-40);" title="{{ t('underline') }}">
                        <i class="ti ti-underline" style="color: var(--primary-700);"></i>
                      </button>
                      <div class="w-px mx-1" style="background: var(--primary-300);"></div>
                      <button type="button" (click)="applyFormat($event, 'insertUnorderedList')"
                        class="w-8 h-8 rounded flex items-center justify-center transition-all hover:scale-110 toolbar-button"
                        style="background: var(--primary-300-40);" title="{{ t('bullet_list') }}">
                        <i class="ti ti-list" style="color: var(--primary-700);"></i>
                      </button>
                      <button type="button" (click)="applyFormat($event, 'insertOrderedList')"
                        class="w-8 h-8 rounded flex items-center justify-center transition-all hover:scale-110 toolbar-button"
                        style="background: var(--primary-300-40);" title="{{ t('numbered_list') }}">
                        <i class="ti ti-list-numbers" style="color: var(--primary-700);"></i>
                      </button>
                    </div>

                    <div contenteditable="true" (input)="onCommentInput($event)" (change)="onCommentInput($event)"
                      class="w-full min-h-[150px] p-4 rounded-lg focus:outline-none reviewEditor"
                      style="background: var(--primary-100-40) !important; color: var(--primary-700); border: 2px solid var(--primary-300);"
                      attr.placeholder="{{t('share_experience')}}"></div>
                  </div>

                  <div class="flex gap-3 mt-4">
                    <button (click)="submitReview()" [class.disabled]="checkReview()"
                      class="flex-1 px-6 py-3 rounded-xl text-base font-semibold transition-all hover:scale-[1.02]"
                      style="background: var(--gradient-primary); color: white;">
                      <i class="ti ti-send mr-2"></i>
                      {{ t('submit_review') }}
                    </button>
                  </div>
                </div>
                }
                } @else {
                <div class="p-4 rounded-2xl text-center glass" style="background: var(--primary-300-40);">
                  <p style="color: var(--primary-600);">
                    <i class="ti ti-login mr-2"></i>
                    {{ t('please_log_in_to_review') }}
                  </p>
                </div>
                }

                <!-- User's Own Review (if authenticated and exists) -->
                @if (userReview) {
                <div class="yourReview p-6 glass rounded-2xl border-2"
                  style="background: var(--primary-300-40); border-color: var(--primary-500);">
                  <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                      <i class="ti ti-star-filled text-lg" style="color: var(--primary-500);"></i>
                      <h4 class="yourReviewTitle  text-lg font-semibold" style="color: var(--primary-700);">{{
                        t('your_review') }}</h4>
                    </div>
                    <button
                      class="btn btn-primary text-sm flex flex-row gap-2 deleteBut hover:scale-110 min-h-10 min-w-10 text-nowrap transition-all"
                      [class.w-10]="!confirmDeleteReview" [class.w-52]="confirmDeleteReview" style="background: red"
                      (click)="confirmDeleteReviewPrompt($event)" (blur)="cancelReviewDelete($event)">
                      @if (!confirmDeleteReview) {
                      <i class="ti ti-trash"></i>
                      } @else {
                      {{ t('are_you_sure') }}
                      <button class="confirmDelete py-0.5 px-1.5 rounded-xl hover:bg-red-400 transition-all"
                        (click)="deleteReview(userReview.id)">
                        <i class="ti ti-check"></i>
                      </button>
                      }
                    </button>
                  </div>
                  <div class="yourReviewCont flex items-start gap-3">
                    <img *ngIf="user.profileImageString" class="object-cover w-12 h-12 rounded-full border-2"
                      alt="Your profile" src="data:image/jpeg;base64,{{user.profileImageString}}"
                      style="background: var(--primary-400); border-color: var(--primary-500);" />
                    <div class="flex-1">
                      <div class="flex items-center justify-between mb-2">
                        <div>
                          <p class="font-bold text-base" style="color: var(--primary-700);">{{ user?.username }}</p>
                          <div class="flex items-center gap-1 mt-1">
                            @for (i of [1,2,3,4,5]; track i) {
                            <i class="ti ti-star-filled text-base"
                              [style.color]="i <= userReview.rating ? '#eab308' : 'var(--primary-300)'"></i>
                            }
                          </div>
                        </div>
                        <span class="text-sm font-medium" style="color: var(--primary-500);">
                          {{ formatReviewDate(userReview.createdAt) }}
                        </span>
                      </div>
                      <div [innerHTML]="userReview.comment" class="reviewComment mt-3 prose prose-sm max-w-none"
                        style="color: var(--primary-600);"></div>
                    </div>
                  </div>
                </div>
                }

                <!-- All Reviews -->
                @if (recipe?.reviews?.length) {
                <div class="space-y-4">
                  <h4 class="text-lg font-semibold flex items-center gap-2" style="color: var(--primary-700);">
                    <i class="ti ti-messages"></i>
                    {{ t('community_reviews') }}
                  </h4>
                  @for (review of uniqueReviews; track review.id) {
                  <div class="reviewCont p-5 glass rounded-2xl transition-all hover:scale-[1.01]"
                    style="background: var(--primary-200-40);">
                    <div class="flex items-start gap-3">
                      <img class="w-10 h-10 rounded-full object-cover border-2"
                        style="background: var(--primary-400); border-color: var(--primary-500);"
                        src="{{review.authorPfp}}" alt="User profile" />
                      <div class="flex-1">
                        <div class="flex items-center justify-between mb-2">
                          <div>
                            <p class="font-semibold text-base" style="color: var(--primary-700);">
                              {{ review.authorUsername || review.author || t('unknown_user') }}
                            </p>
                            <div class="flex items-center gap-1 mt-1">
                              @for (i of [1,2,3,4,5]; track i) {
                              <i class="ti ti-star-filled text-sm"
                                [style.color]="i <= review.rating ? '#eab308' : 'var(--primary-300)'"></i>
                              }
                            </div>
                          </div>
                          <span class="text-sm font-medium" style="color: var(--primary-400);">
                            {{ formatReviewDate(review.createdAt) }}
                          </span>
                        </div>
                        <div [innerHTML]="review.comment" class="mt-2 prose prose-sm max-w-none"
                          style="color: var(--primary-600);"></div>
                      </div>
                    </div>
                  </div>
                  }

                  <!-- Load More Button -->
                  @if (hasMoreReviews) {
                  <button (click)="loadMoreReviews()" [disabled]="loadingReviews"
                    class="w-full px-6 py-4 rounded-2xl text-base font-semibold transition-all hover:scale-[1.02] flex items-center justify-center gap-3"
                    [class.opacity-50]="loadingReviews" style="background: var(--primary-400); color: white;">
                    @if (loadingReviews) {
                    <div [innerHTML]="logos.get('Rarecips_Spinner')" class="[&>svg]:h-6"></div>
                    {{ t('loading_more_reviews') }}
                    } @else {
                    <i class="ti ti-chevron-down text-xl"></i>
                    {{ t('load_more_reviews') }}
                    }
                  </button>
                  }
                </div>
                } @else if (!userReview) {
                <div class="text-center py-8">
                  <i class="ti ti-message-off text-6xl mb-4" style="color: var(--primary-300);"></i>
                  <p class="text-lg" style="color: var(--primary-400);">{{ t('no_reviews_yet') }}</p>
                  <p class="text-sm" style="color: var(--primary-400);">{{ t('be_first_to_review') }}</p>
                </div>
                }
              </div>
            </div>
            }
          </div>
        </div>
      </ng-template>

      <ng-template #ingredientsContent>
        <div class="flex flex-col gap-6 rounded-3xl border border-solid px-8 py-8 shadow-sm glass sticky top-8"
          style="border-color: var(--primary-100-40); background: var(--primary-200-40);">

          <div class="flex flex-col items-center justify-between gap-4">
            <div class="flex w-full">
              <h3 class="flex items-center text-xl font-semibold" style="color: var(--primary-700);">
                <i class="ti ti-shopping-cart mr-2"></i>
                {{ t('ingredients') }}
              </h3>
            </div>
            <div class="flex items-center gap-2">
              <div class="servings-control flex items-center gap-2 px-3 py-2 rounded-lg"
                style="background: var(--primary-300-40);">
                <button (mousedown)="startHoldDecrement()" (mouseup)="stopHold()" (mouseleave)="stopHold()"
                  (touchstart)="startHoldDecrement()" (touchend)="stopHold()" [disabled]="currentServings <= 1"
                  class="w-8 h-8 rounded-lg flex items-center justify-center transition-all hover:scale-110"
                  [style.background]="currentServings <= 1 ? 'var(--primary-400)' : 'var(--primary-500)'"
                  [style.color]="'white'" [style.opacity]="currentServings <= 1 ? '0.5' : '1'"
                  [style.cursor]="currentServings <= 1 ? 'not-allowed' : 'pointer'">
                  <i class="ti ti-minus"></i>
                </button>
                <span class="text-sm font-bold min-w-[4rem] text-center" style="color: var(--primary-700);">
                  {{ currentServings }} {{ t('people') }}
                </span>
                <button (mousedown)="startHoldIncrement()" (mouseup)="stopHold()" (mouseleave)="stopHold()"
                  (touchstart)="startHoldIncrement()" (touchend)="stopHold()"
                  class="w-8 h-8 rounded-lg flex items-center justify-center transition-all hover:scale-110"
                  style="background: var(--primary-500); color: white; cursor: pointer;">
                  <i class="ti ti-plus"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="space-y-4">
            @for (ingredient of recipe?.ingredients; track $index) {
            <label class="flex items-center glass gap-4 p-3 ingredient-item cursor-pointer"
              style="background: var(--primary-200-40);">
              <input type="checkbox" class="w-4 h-4 rounded form-checkbox" style="accent-color: var(--primary-500);">
              <span class="w-7 h-7 checkbox-custom glass-input !rounded-full"></span>
              <div class="flex items-center gap-2 flex-1">
                <i class="ti {{ ingredientIconService.getIconForIngredient(ingredient.food) }} text-xl"
                  style="color: var(--primary-500);"></i>
                <div class="flex-1">
                  <span class="font-medium" style="color: var(--primary-700);">{{ ingredient.food }}</span>
                  <div class="text-sm" style="color: var(--primary-400);">
                    {{ getScaledQuantity(ingredient.quantity) }} {{ ingredient.measure }}
                  </div>
                </div>
              </div>
              @if (isAuthenticated) {
              @if (userIngredients.size > 0 && hasIngredientInPantry(ingredient.id, ingredient)) {
              <i class="ti ti-basket-check mr-4 text-xl text-green-500"></i>
              } @else {
              <i class="ti ti-basket-x mr-4 text-xl text-red-500 hover:text-primary-700 cursor-pointer"></i>
              }
              }
            </label>
            }
          </div>
        </div>
      </ng-template>

      @if (!responsive) {
      <div class="flex flex-row gap-8">
        <div class="flex flex-col gap-8 w-3/4">
          <ng-container *ngTemplateOutlet="recipeContent"></ng-container>
        </div>
        <div class="ingredients flex flex-col w-1/4">
          <div class="lg:col-span-1">
            <ng-container *ngTemplateOutlet="ingredientsContent"></ng-container>
          </div>
        </div>
      </div>
      } @else {
      <div class="carousel-container w-full max-w-[90vw] mx-auto mb-8">
        <div class="carousel-indicators flex justify-center mb-4 gap-2">
          @for (card of carouselCards; track $index) {
          <div class="indicator w-2 h-2 rounded-full cursor-pointer transition-all duration-300"
            [class.active]="currentCarouselIndex === $index"
            [style.background-color]="currentCarouselIndex === $index ? 'var(--primary-600)' : 'var(--primary-300)'"
            [style.width]="currentCarouselIndex === $index ? '24px' : '8px'"
            [style.border-radius]="currentCarouselIndex === $index ? '4px' : '50%'" (click)="goToCarouselCard($index)">
          </div>
          }
        </div>

        <div class="carousel-wrapper" (touchstart)="onCarouselTouchStart($event)"
          (touchmove)="onCarouselTouchMove($event)" (touchend)="onCarouselTouchEnd($event)">
          <div class="carousel-track"
            [style.transform]="'translateX(calc(-' + currentCarouselIndex * 100 + '% + ' + carouselTranslate + 'px))'">
            <div class="carousel-card w-full flex-shrink-0">
              <ng-container *ngTemplateOutlet="recipeContent"></ng-container>
            </div>
            <div class="carousel-card w-full flex-shrink-0">
              <ng-container *ngTemplateOutlet="ingredientsContent"></ng-container>
            </div>
          </div>
        </div>
      </div>
      }

    </div>
  </div>

  <!-- Focus Mode Modal -->
  @if (focusMode) {
  <div class="fixed inset-0 z-50 flex items-center justify-center visibleBackdrop" [class.closing]="focusModeClosing"
    style="backdrop-filter: blur(10px); background: var(--primary-backdrop); pointer-events: auto;">
    <div class="w-11/12 max-w-4xl rounded-3xl shadow-2xl p-8 relative focus-mode-modal"
      [class.closing]="focusModeClosing" style="background: var(--primary-200);">

      <!-- Close Button -->
      <button (click)="exitFocusMode($event)"
        class="absolute top-6 right-6 w-12 h-12 rounded-full flex items-center justify-center transition-all hover:scale-110 hover:rotate-90"
        style="background: var(--primary-400); color: white; box-shadow: 0 4px 12px var(--primary-300);">
        <i class="ti ti-x text-2xl"></i>
      </button>

      <!-- Timer Display -->
      <div class="flex flex-col items-center gap-6 mb-8">
        <div class="flex items-center gap-3">
          <i class="ti ti-clock text-4xl" style="color: var(--primary-600);"></i>
          <span class="text-2xl font-semibold" style="color: var(--primary-600);">{{ t('cooking_timer') }}</span>
        </div>

        <div class="text-8xl font-mono font-bold tracking-wider focus-timer" style="color: var(--primary-700);">
          {{ formatTime }}
        </div>

        <!-- Timer Controls -->
        <div class="flex gap-4">
          <button (click)="startTimer()" [disabled]="timerRunning"
            class="px-8 py-4 rounded-2xl text-lg font-semibold flex items-center gap-3 transition-all hover:scale-105 shadow-lg"
            [ngClass]="{'opacity-50 cursor-not-allowed': timerRunning}"
            style="background: var(--gradient-primary); color: white;">
            <i class="ti ti-player-play text-2xl"></i> {{ t('start') }}
          </button>

          <button (click)="pauseTimer()" [disabled]="!timerRunning"
            class="px-8 py-4 rounded-2xl text-lg font-semibold flex items-center gap-3 transition-all hover:scale-105 shadow-lg"
            [ngClass]="{'opacity-50 cursor-not-allowed': !timerRunning}"
            style="background: var(--gradient-primary); color: white;">
            <i class="ti ti-player-pause text-2xl"></i> {{ t('pause') }}
          </button>

          <button (click)="resetTimer()"
            class="px-8 py-4 rounded-2xl text-lg font-semibold flex items-center gap-3 transition-all hover:scale-105 shadow-lg"
            style="background: var(--gradient-primary); color: white;">
            <i class="ti ti-refresh text-2xl"></i> {{ t('reset') }}
          </button>
        </div>
      </div>

      <!-- Current Step Display -->
      <div class="rounded-2xl p-8 mb-6 focus-step-card overflow-hidden"
        style="background: var(--primary-400); color: var(--primary-text);">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl font-bold"
              style="background: var(--primary-500); box-shadow: 0 4px 12px var(--primary-500); color: var(--primary-text);">
              {{ currentStep + 1 }}
            </div>
          </div>
        </div>

        <div class="max-h-64 overflow-y-auto custom-scrollbar pr-2" style="margin-right: -8px;">
          <p class="text-2xl leading-relaxed font-medium">
            {{ getSteps()[currentStep] }}
          </p>
        </div>
      </div>

      <!-- Step Navigation -->
      <div class="steps flex items-center justify-between gap-4">
        <button (click)="previousStep()" [disabled]="currentStep === 0"
          class="px-8 py-4 rounded-2xl text-lg font-semibold flex items-center gap-3 transition-all hover:scale-105 shadow-md"
          [ngClass]="{'opacity-40 cursor-not-allowed': currentStep === 0}"
          style="background: var(--primary-300); color: var(--primary-text);">
          <i class="ti ti-arrow-left text-xl"></i>
          {{ t('previous') }}
        </button>

        <!-- Step Progress Dots -->
        <div class="flex gap-2 min-h-max items-center">
          @for (step of getSteps(); track $index) {
          <button (click)="goToStep($index)" class="transition-all hover:scale-125 focus-step-progress"
            [style.width]="$index === currentStep ? '12px' : '8px'"
            [style.height]="$index === currentStep ? '12px' : '8px'"
            [style.background]="$index === currentStep ? 'var(--primary-600)' : 'var(--primary-300)'"
            style="border-radius: 50%; border: none; cursor: pointer;"></button>
          }
        </div>

        <button (click)="nextStep()"
          class="px-8 py-4 rounded-2xl text-lg font-semibold flex items-center gap-3 transition-all hover:scale-105 shadow-md"
          style="background: var(--primary-600); color: white;">
          {{ nextLabel }}
          <i class="ti text-xl" [class.ti-arrow-right]="currentStep < getSteps().length - 1"
            [class.ti-tools-kitchen-2]="currentStep == getSteps().length - 1 || getSteps().length == 0"></i>
        </button>
      </div>
    </div>
  </div>
  }
</div>

<app-collection-card [mode]="'add-dialog'" [recipeId]="selectedRecipeId" [showDialog]="showAddToCollectionDialog"
  (onClose)="closeAddToCollection()" (onAdded)="onRecipeAddedToCollection()">
</app-collection-card>
